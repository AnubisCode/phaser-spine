/*!
 * phaser-spine - version 3.1.0-alpha1 
 * Spine plugin for Phaser.io!
 *
 * OrangeGames
 * Build at 17-08-2017
 * Released under MIT License 
 */

var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},PhaserSpine;!function(a){var b;!function(b){var c=function(){function b(a){this.game=a}return b.prototype.resize=function(a,b,c){var d=c.resolution;c.context.resetTransform(),c.context.scale(b.x*d,b.y*d),c.context.translate(a.width/2/b.x,a.height/b.y/d),d>1&&c.context.translate(0,a.height/b.y/d/2),c.context.translate(a.x/b.x,a.y/b.y)},b.prototype.drawImages=function(b,c){var d=c.context,e=b.drawOrder,f=c.resolution;a.SpinePlugin.DEBUG&&(d.strokeStyle="green");for(var g=0,h=e.length;g<h;g++){var i=e[g],j=i.getAttachment(),k=null,l=null,m=null;if(j instanceof spine.RegionAttachment){var n=j;m=n.updateWorldVertices(i,!1),k=n.region,l=k.texture.getImage();var o=j,p=i.bone,q=m[0],r=m[1],s=(p.getWorldRotationX()-o.rotation)*Math.PI/180,t=m[24]-m[0],u=m[25]-m[1],v=m[8]-m[0],w=m[9]-m[1],x=Math.sqrt(t*t+u*u),y=-Math.sqrt(v*v+w*w);d.translate(q/f,r/f),d.rotate(s),k.rotate?(d.rotate(Math.PI/2),d.drawImage(l,k.x,k.y,k.height,k.width,0,0,y/f,-x/f),d.rotate(-Math.PI/2)):d.drawImage(l,k.x,k.y,k.width,k.height,0,0,x/f,y/f),a.SpinePlugin.DEBUG&&d.strokeRect(0,0,x/f,y/f),d.rotate(-s),d.translate(-q/f,-r/f)}}},b.prototype.drawTriangles=function(c,d){for(var e=null,f=null,g=null,h=c.drawOrder,i=d.resolution,j=0,k=h.length;j<k;j++){var l=h[j],m=l.getAttachment(),n=null,o=null;if(m instanceof spine.RegionAttachment){var p=m;f=p.updateWorldVertices(l,!1),g=b.QUAD_TRIANGLES,o=p.region,n=o.texture.getImage()}else{if(!(m instanceof spine.MeshAttachment))continue;var q=m;f=q.updateWorldVertices(l,!1),g=q.triangles,n=q.region.renderObject.texture.getImage()}if(null!=n){var r=l.data.blendMode;r!=e&&(e=r);for(var s=d.context,t=0;t<g.length;t+=3){var u=8*g[t],v=8*g[t+1],w=8*g[t+2],x=f[u],y=f[u+1],z=f[u+6],A=f[u+7],B=f[v],C=f[v+1],D=f[v+6],E=f[v+7],F=f[w],G=f[w+1],H=f[w+6],I=f[w+7];this.drawTriangle(d,n,x/i,y/i,z,A,B/i,C/i,D,E,F/i,G/i,H,I),a.SpinePlugin.DEBUG&&(s.strokeStyle="green",s.beginPath(),s.moveTo(x/i,y/i),s.lineTo(B/i,C/i),s.lineTo(F/i,G/i),s.lineTo(x/i,y/i),s.stroke())}}}},b.prototype.drawTriangle=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=a.context;e*=b.width,f*=b.height,i*=b.width,j*=b.height,m*=b.width,n*=b.height,o.beginPath(),o.moveTo(c,d),o.lineTo(g,h),o.lineTo(k,l),o.closePath(),g-=c,h-=d,k-=c,l-=d,i-=e,j-=f,m-=e,n-=f;var p=1/(i*n-m*j),q=(n*g-j*k)*p,r=(n*h-j*l)*p,s=(i*k-m*g)*p,t=(i*l-m*h)*p,u=c-q*e-s*f,v=d-r*e-t*f;o.save(),o.transform(q,r,s,t,u,v),o.clip(),o.drawImage(b,0,0),o.restore()},b}();c.QUAD_TRIANGLES=[0,1,2,2,3,0],b.Renderer=c}(b=a.Canvas||(a.Canvas={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(a){var b=function(a){function b(b){return a.call(this,b)||this}return __extends(b,a),b.prototype.setFilters=function(a,b){},b.prototype.setWraps=function(a,b){},b.prototype.dispose=function(){},b}(spine.Texture);a.Texture=b}(b=a.Canvas||(a.Canvas={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b=function(b){function c(a,c){return b.call(this,a,c)||this}return __extends(c,b),c.prototype.init=function(a){c.DEBUG=a.debugRendering||!1,c.TRIANGLE=a.triangleRendering||!1,this.addSpineCache(),this.addSpineFactory(),this.addSpineLoader()},c.prototype.addSpineLoader=function(){Phaser.Loader.prototype.spine=function(a,b,d){var e=b.substr(0,b.lastIndexOf("."));this.text(c.SPINE_NAMESPACE+a,e+".atlas"),this.json(c.SPINE_NAMESPACE+a,e+".json"),this.image(c.SPINE_NAMESPACE+a,e+".png")}},c.prototype.addSpineFactory=function(){Phaser.GameObjectFactory.prototype.spine=function(b,c,d,e,f){void 0===f&&(f=this.world);var g=new a.Spine(this.game,b,c,d);return f.add(g)},Phaser.GameObjectCreator.prototype.spine=function(a,b,c,d,e){return null}},c.prototype.addSpineCache=function(){Phaser.Cache.prototype.spine={},Phaser.Cache.prototype.addSpine=function(a,b){this.spine[a]=b},Phaser.Cache.prototype.getSpine=function(a){return!this.spine.hasOwnProperty(a),this.spine[a]}},c}(Phaser.Plugin);b.RESOLUTION_REGEXP=/@(.+)x/,b.SPINE_NAMESPACE="spine",b.DEBUG=!1,b.TRIANGLE=!1,a.SpinePlugin=b}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b=function(b){function c(c,d,e,f){var g=b.call(this,c,d,e,a.SpinePlugin.SPINE_NAMESPACE+f)||this;g.skeleton=g.createSkeleton(f),g.skeleton.flipY=g.game.renderType===Phaser.CANVAS,g.skeleton.setToSetupPose(),g.skeleton.updateWorldTransform();var h=new spine.Vector2;g.skeleton.getBounds(new spine.Vector2,h),g.texture.setFrame(new PIXI.Rectangle(0,0,h.x,h.y)),g.skeleton.setToSetupPose(),g.skeleton.updateWorldTransform();var i=new spine.Vector2,h=new spine.Vector2;return g.skeleton.getBounds(i,h),g.specialBounds=new PIXI.Rectangle(i.x,i.y,h.x,h.y),g.state=new spine.AnimationState(new spine.AnimationStateData(g.skeleton.data)),g.game.renderType===Phaser.CANVAS?g.renderer=new a.Canvas.Renderer(g.game):g.renderer=new a.WebGL.Renderer(g.game),g}return __extends(c,b),c.prototype.createSkeleton=function(b){var c=this,d=new spine.TextureAtlas(this.game.cache.getText(a.SpinePlugin.SPINE_NAMESPACE+b),function(d){return c.game.renderType===Phaser.CANVAS?new a.Canvas.Texture(c.game.cache.getImage(a.SpinePlugin.SPINE_NAMESPACE+b)):new a.WebGL.Texture(c.game.renderer.gl,c.game.cache.getImage(a.SpinePlugin.SPINE_NAMESPACE+b))}),e=new spine.AtlasAttachmentLoader(d),f=new spine.SkeletonJson(e),g=f.readSkeletonData(this.game.cache.getJSON(a.SpinePlugin.SPINE_NAMESPACE+b));return new spine.Skeleton(g)},c.prototype.update=function(){b.prototype.update.call(this),this.state.update(this.game.time.elapsed/1e3),this.state.apply(this.skeleton),this.skeleton.updateWorldTransform()},c.prototype._renderCanvas=function(b,c){this.visible&&this.alive&&(this.renderer.resize(this.getBounds(),this.scale,b),a.SpinePlugin.TRIANGLE?this.renderer.drawTriangles(this.skeleton,b):this.renderer.drawImages(this.skeleton,b))},c.prototype._renderWebGL=function(a,b){this.visible&&this.alive&&(this.renderer.resize(this.skeleton,this.getBounds(),this.scale,a),this.renderer.draw(this.skeleton,a))},c}(Phaser.Sprite);a.Spine=b}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(b){var c=function(){function b(a){this.mvp=new spine.webgl.Matrix4,this.game=a;var b=this.game.renderer.renderSession.gl;this.shader=spine.webgl.Shader.newColoredTextured(b),this.batcher=new spine.webgl.PolygonBatcher(b),this.mvp.ortho2d(0,0,this.game.width-1,this.game.height-1),this.skeletonRenderer=new spine.webgl.SkeletonRenderer(b),this.debugRenderer=new spine.webgl.SkeletonDebugRenderer(b),this.debugRenderer.drawRegionAttachments=!1,this.debugRenderer.drawBoundingBoxes=!1,this.debugRenderer.drawMeshHull=!1,this.debugRenderer.drawMeshTriangles=!1,this.debugRenderer.drawPaths=!1,this.debugShader=spine.webgl.Shader.newColored(b),this.shapes=new spine.webgl.ShapeRenderer(b)}return b.prototype.resize=function(a,b,c,d){var e=this.game.width,f=this.game.height,g=d.resolution;a.flipX=c.x<0,a.flipY=c.y<0;var h=Math.max(c.x,c.y),i=e/h,j=f/h,k=-b.centerX,l=(-f+b.centerY)*g+b.height/2,m=k/h,n=l/h;this.mvp.ortho2d(m*g,n,i*g,j*g),d.gl.viewport(0,0,e*g,f*g)},b.prototype.draw=function(b,c){c.spriteBatch.end();for(var d=c.blendModeManager.currentBlendMode,e=c.shaderManager.currentShader,f=0;f<c.shaderManager.attribState.length;f++)c.shaderManager.attribState[f]=null,c.gl.disableVertexAttribArray(f);this.shader.bind(),this.shader.setUniformi(spine.webgl.Shader.SAMPLER,0),this.shader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX,this.mvp.values),this.batcher.begin(this.shader),this.skeletonRenderer.draw(this.batcher,b),this.batcher.end(),this.shader.unbind(),a.SpinePlugin.DEBUG&&(this.debugShader.bind(),this.debugShader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX,this.mvp.values),this.debugRenderer.premultipliedAlpha=!1,this.shapes.begin(this.debugShader),this.debugRenderer.draw(this.shapes,b),this.shapes.end(),this.debugShader.unbind()),c.blendModeManager.currentBlendMode=-1,c.blendModeManager.setBlendMode(d),c.gl.enable(c.gl.BLEND),c.shaderManager._currentId=null,c.shaderManager.setShader(e),c.spriteBatch.dirty=!0,["2.7.3","2.7.4","2.7.5","2.7.6","2.7.7"].indexOf(Phaser.VERSION)>-1&&c.spriteBatch.sprites.map(function(a){a.texture&&a.texture.baseTexture&&(a.texture.baseTexture._dirty[c.spriteBatch.gl.id]=!0)}),c.drawCount++},b}();b.Renderer=c}(b=a.WebGL||(a.WebGL={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(a){var b=function(a){function b(b,c,d){void 0===d&&(d=!1);var e=a.call(this,c)||this;return e.boundUnit=0,e.gl=b,e.texture=b.createTexture(),e.update(d),e}return __extends(b,a),b.prototype.setFilters=function(a,b){var c=this.gl;this.bind(),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,b)},b.prototype.setWraps=function(a,b){var c=this.gl;this.bind(),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,b)},b.prototype.update=function(a){var b=this.gl;this.bind(),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,this._image),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,a?b.LINEAR_MIPMAP_LINEAR:b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a&&b.generateMipmap(b.TEXTURE_2D)},b.prototype.bind=function(a){void 0===a&&(a=0);var b=this.gl;this.boundUnit=a,b.activeTexture(b.TEXTURE0+a),b.bindTexture(b.TEXTURE_2D,this.texture)},b.prototype.unbind=function(){var a=this.gl;a.activeTexture(a.TEXTURE0+this.boundUnit),a.bindTexture(a.TEXTURE_2D,null)},b.prototype.dispose=function(){var a=this.gl;a.deleteTexture(this.texture)},b}(spine.Texture);a.Texture=b}(b=a.WebGL||(a.WebGL={}))}(PhaserSpine||(PhaserSpine={}));