/*!
 * phaser-spine - version 3.1.0-alpha1 
 * Spine plugin for Phaser.io!
 *
 * OrangeGames
 * Build at 25-01-2017
 * Released under MIT License 
 */

var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},PhaserSpine;!function(a){var b;!function(b){var c=function(){function b(a){this.game=a}return b.prototype.resize=function(a,b,c){c.context.resetTransform(),c.context.scale(b.x,b.y),c.context.translate(a.width/2/b.x,a.height/b.y),c.context.translate(a.x/b.x,a.y/b.y)},b.prototype.drawImages=function(b,c){var d=c.context,e=b.drawOrder;a.SpinePlugin.DEBUG&&(d.strokeStyle="green");for(var f=0,g=e.length;f<g;f++){var h=e[f],i=h.getAttachment(),j=null,k=null,l=null;if(i instanceof spine.RegionAttachment){var m=i;l=m.updateWorldVertices(h,!1),j=m.region,k=j.texture.getImage();var n=i,o=h.bone,p=l[0],q=l[1],r=(o.getWorldRotationX()-n.rotation)*Math.PI/180,s=l[24]-l[0],t=l[25]-l[1],u=l[8]-l[0],v=l[9]-l[1],w=Math.sqrt(s*s+t*t),x=-Math.sqrt(u*u+v*v);d.translate(p,q),d.rotate(r),j.rotate?(d.rotate(Math.PI/2),d.drawImage(k,j.x,j.y,j.height,j.width,0,0,x,-w),d.rotate(-Math.PI/2)):d.drawImage(k,j.x,j.y,j.width,j.height,0,0,w,x),a.SpinePlugin.DEBUG&&d.strokeRect(0,0,w,x),d.rotate(-r),d.translate(-p,-q)}}},b.prototype.drawTriangles=function(c,d){for(var e=null,f=null,g=null,h=c.drawOrder,i=0,j=h.length;i<j;i++){var k=h[i],l=k.getAttachment(),m=null,n=null;if(l instanceof spine.RegionAttachment){var o=l;f=o.updateWorldVertices(k,!1),g=b.QUAD_TRIANGLES,n=o.region,m=n.texture.getImage()}else{if(!(l instanceof spine.MeshAttachment))continue;var p=l;f=p.updateWorldVertices(k,!1),g=p.triangles,m=p.region.renderObject.texture.getImage()}if(null!=m){var q=k.data.blendMode;q!=e&&(e=q);for(var r=d.context,s=0;s<g.length;s+=3){var t=8*g[s],u=8*g[s+1],v=8*g[s+2],w=f[t],x=f[t+1],y=f[t+6],z=f[t+7],A=f[u],B=f[u+1],C=f[u+6],D=f[u+7],E=f[v],F=f[v+1],G=f[v+6],H=f[v+7];this.drawTriangle(d,m,w,x,y,z,A,B,C,D,E,F,G,H),a.SpinePlugin.DEBUG&&(r.strokeStyle="green",r.beginPath(),r.moveTo(w,x),r.lineTo(A,B),r.lineTo(E,F),r.lineTo(w,x),r.stroke())}}}},b.prototype.drawTriangle=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=a.context;e*=b.width,f*=b.height,i*=b.width,j*=b.height,m*=b.width,n*=b.height,o.beginPath(),o.moveTo(c,d),o.lineTo(g,h),o.lineTo(k,l),o.closePath(),g-=c,h-=d,k-=c,l-=d,i-=e,j-=f,m-=e,n-=f;var p=1/(i*n-m*j),q=(n*g-j*k)*p,r=(n*h-j*l)*p,s=(i*k-m*g)*p,t=(i*l-m*h)*p,u=c-q*e-s*f,v=d-r*e-t*f;o.save(),o.transform(q,r,s,t,u,v),o.clip(),o.drawImage(b,0,0),o.restore()},b}();c.QUAD_TRIANGLES=[0,1,2,2,3,0],b.Renderer=c}(b=a.Canvas||(a.Canvas={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(a){var b=function(a){function b(b){return a.call(this,b)||this}return __extends(b,a),b.prototype.setFilters=function(a,b){},b.prototype.setWraps=function(a,b){},b.prototype.dispose=function(){},b}(spine.Texture);a.Texture=b}(b=a.Canvas||(a.Canvas={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b=function(b){function c(a,c){return b.call(this,a,c)||this}return __extends(c,b),c.prototype.init=function(a){c.DEBUG=a.debugRendering||!1,c.TRIANGLE=a.triangleRendering||!1,this.addSpineCache(),this.addSpineFactory(),this.addSpineLoader()},c.prototype.addSpineLoader=function(){Phaser.Loader.prototype.spine=function(a,b,d){var e=b.substr(0,b.lastIndexOf("."));this.text(c.SPINE_NAMESPACE+a,e+".atlas"),this.json(c.SPINE_NAMESPACE+a,e+".json"),this.image(c.SPINE_NAMESPACE+a,e+".png")}},c.prototype.addSpineFactory=function(){Phaser.GameObjectFactory.prototype.spine=function(b,c,d,e,f){void 0===f&&(f=this.world);var g=new a.Spine(this.game,b,c,d);return f.add(g)},Phaser.GameObjectCreator.prototype.spine=function(a,b,c,d,e){return null}},c.prototype.addSpineCache=function(){Phaser.Cache.prototype.spine={},Phaser.Cache.prototype.addSpine=function(a,b){this.spine[a]=b},Phaser.Cache.prototype.getSpine=function(a){return!this.spine.hasOwnProperty(a),this.spine[a]}},c}(Phaser.Plugin);b.RESOLUTION_REGEXP=/@(.+)x/,b.SPINE_NAMESPACE="spine",b.DEBUG=!1,b.TRIANGLE=!1,a.SpinePlugin=b}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b=function(b){function c(c,d,e,f){var g=b.call(this,c,d,e,a.SpinePlugin.SPINE_NAMESPACE+f)||this;g.skeleton=g.createSkeleton(f),g.skeleton.flipY=g.game.renderType===Phaser.CANVAS,g.skeleton.setToSetupPose(),g.skeleton.updateWorldTransform();var h=new spine.Vector2;g.skeleton.getBounds(new spine.Vector2,h),g.texture.setFrame(new PIXI.Rectangle(0,0,h.x,h.y)),g.skeleton.setToSetupPose(),g.skeleton.updateWorldTransform();var i=new spine.Vector2,h=new spine.Vector2;return g.skeleton.getBounds(i,h),g.specialBounds=new PIXI.Rectangle(i.x,i.y,h.x,h.y),g.state=new spine.AnimationState(new spine.AnimationStateData(g.skeleton.data)),g.game.renderType===Phaser.CANVAS?g.renderer=new a.Canvas.Renderer(g.game):g.renderer=new a.WebGL.Renderer(g.game),g}return __extends(c,b),c.prototype.createSkeleton=function(b){var c=this,d=new spine.TextureAtlas(this.game.cache.getText(a.SpinePlugin.SPINE_NAMESPACE+b),function(d){return c.game.renderType===Phaser.CANVAS?new a.Canvas.Texture(c.game.cache.getImage(a.SpinePlugin.SPINE_NAMESPACE+b)):new a.WebGL.Texture(c.game.renderer.gl,c.game.cache.getImage(a.SpinePlugin.SPINE_NAMESPACE+b))}),e=new spine.AtlasAttachmentLoader(d),f=new spine.SkeletonJson(e),g=f.readSkeletonData(this.game.cache.getJSON(a.SpinePlugin.SPINE_NAMESPACE+b));return new spine.Skeleton(g)},c.prototype.update=function(){b.prototype.update.call(this),this.state.update(this.game.time.elapsed/1e3),this.state.apply(this.skeleton),this.skeleton.updateWorldTransform()},c.prototype._renderCanvas=function(b,c){this.visible&&this.alive&&(this.renderer.resize(this.getBounds(),this.scale,b),a.SpinePlugin.TRIANGLE?this.renderer.drawTriangles(this.skeleton,b):this.renderer.drawImages(this.skeleton,b))},c.prototype._renderWebGL=function(a,b){this.visible&&this.alive&&(this.renderer.resize(this.specialBounds,this.scale,a),this.renderer.draw(this.skeleton,a))},c}(Phaser.Sprite);a.Spine=b}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(b){var c=function(){function b(a){this.mvp=new spine.webgl.Matrix4,this.game=a;var b=this.game.renderer.renderSession.gl;this.shader=spine.webgl.Shader.newColoredTextured(b),this.batcher=new spine.webgl.PolygonBatcher(b),this.mvp.ortho2d(0,0,this.game.width-1,this.game.height-1),this.skeletonRenderer=new spine.webgl.SkeletonRenderer(b),this.debugRenderer=new spine.webgl.SkeletonDebugRenderer(b),this.debugRenderer.drawRegionAttachments=!1,this.debugRenderer.drawBoundingBoxes=!1,this.debugRenderer.drawMeshHull=!1,this.debugRenderer.drawMeshTriangles=!1,this.debugRenderer.drawPaths=!1,this.debugShader=spine.webgl.Shader.newColored(b),this.shapes=new spine.webgl.ShapeRenderer(b)}return b.prototype.resize=function(a,b,c){var d=this.game.width,e=this.game.height,f=a.x+a.width/2,g=a.y+a.height/2,h=a.width/d,i=a.height/e,j=1.2*Math.max(h,i);j<1&&(j=1);var k=d*j,l=e*j;this.mvp.ortho2d(f-k/2,g-l/2,k,l),c.gl.viewport(0,0,d,e)},b.prototype.draw=function(b,c){this.shader.bind(),this.shader.setUniformi(spine.webgl.Shader.SAMPLER,0),this.shader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX,this.mvp.values),this.batcher.begin(this.shader),this.skeletonRenderer.draw(this.batcher,b),this.batcher.end(),this.shader.unbind(),a.SpinePlugin.DEBUG&&(this.debugShader.bind(),this.debugShader.setUniform4x4f(spine.webgl.Shader.MVP_MATRIX,this.mvp.values),this.debugRenderer.premultipliedAlpha=!1,this.shapes.begin(this.debugShader),this.debugRenderer.draw(this.shapes,b),this.shapes.end(),this.debugShader.unbind())},b}();b.Renderer=c}(b=a.WebGL||(a.WebGL={}))}(PhaserSpine||(PhaserSpine={}));var PhaserSpine;!function(a){var b;!function(a){var b=function(a){function b(b,c,d){void 0===d&&(d=!1);var e=a.call(this,c)||this;return e.boundUnit=0,e.gl=b,e.texture=b.createTexture(),e.update(d),e}return __extends(b,a),b.prototype.setFilters=function(a,b){var c=this.gl;this.bind(),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,b)},b.prototype.setWraps=function(a,b){var c=this.gl;this.bind(),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,b)},b.prototype.update=function(a){var b=this.gl;this.bind(),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,this._image),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,a?b.LINEAR_MIPMAP_LINEAR:b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),a&&b.generateMipmap(b.TEXTURE_2D)},b.prototype.bind=function(a){void 0===a&&(a=0);var b=this.gl;this.boundUnit=a,b.activeTexture(b.TEXTURE0+a),b.bindTexture(b.TEXTURE_2D,this.texture)},b.prototype.unbind=function(){var a=this.gl;a.activeTexture(a.TEXTURE0+this.boundUnit),a.bindTexture(a.TEXTURE_2D,null)},b.prototype.dispose=function(){var a=this.gl;a.deleteTexture(this.texture)},b}(spine.Texture);a.Texture=b}(b=a.WebGL||(a.WebGL={}))}(PhaserSpine||(PhaserSpine={}));